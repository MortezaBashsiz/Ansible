# Generated by iptables-save v1.8.10 (nf_tables) on Mon Dec 30 09:07:57 2024
*filter
:INPUT ACCEPT [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
:DOCKER - [0:0]
:DOCKER-ISOLATION-STAGE-1 - [0:0]
:DOCKER-ISOLATION-STAGE-2 - [0:0]
:DOCKER-USER - [0:0]
-A INPUT -i lo -m comment --comment "Allow loopback traffic" -j ACCEPT

{% if iptables.nic_access is defined %}
{% for nic in iptables.nic_access %}
-A INPUT -i {{ nic }} -j ACCEPT
{% endfor %}
{% endif %}

-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -m comment --comment "Allow established inbound connections" -j ACCEPT
-A INPUT -m conntrack --ctstate INVALID -m comment --comment "Drop invalid packets" -j DROP
-A INPUT -p tcp -m tcp --sport 2221 -m conntrack --ctstate ESTABLISHED -m comment --comment "Allow custom SSH on port 2221" -j ACCEPT
-A INPUT -p tcp -m tcp --dport 2221 -m conntrack --ctstate NEW,ESTABLISHED -m comment --comment "Allow custom SSH on port 2221" -j ACCEPT
-A INPUT -p tcp -m tcp --sport 22 -m conntrack --ctstate ESTABLISHED -m comment --comment "Allow SSH on port 22" -j ACCEPT
-A INPUT -p tcp -m tcp --dport 22 -m conntrack --ctstate NEW,ESTABLISHED -m comment --comment "Allow SSH on port 22" -j ACCEPT
-A INPUT -p tcp -m multiport --dports 80,443 -m conntrack --ctstate NEW,ESTABLISHED -m comment --comment "Allow HTTP and HTTPS traffic" -j ACCEPT

{% if iptables.tcp_port is defined %}
{% for port in iptables.tcp_port %}
-A INPUT -p tcp -m tcp --dport {{ port }} -m conntrack --ctstate NEW,ESTABLISHED  -j ACCEPT
{% endfor %}
{% endif %}

{% if iptables.udp_port is defined %}
{% for uport in iptables.udp_port %}
-A INPUT -p udp -m udp --dport {{ uport }} -m conntrack --ctstate NEW,ESTABLISHED  -j ACCEPT
{% endfor %}
{% endif %}

{% if iptables.ip_access is defined %}
{% for ip in iptables.ip_access %}
-A INPUT -s {{ ip }}   -j ACCEPT
{% endfor %}
{% endif %}

-A INPUT -j DROP
-A FORWARD -m comment --comment "Process forwarding through Docker user-definedd chain" -j DOCKER-USER
-A FORWARD -m comment --comment "Start Docker isolation" -j DOCKER-ISOLATION-STAGE-1
-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -m comment --comment "Allow Docker container return traffic" -j ACCEPT
-A FORWARD -o docker0 -m comment --comment "Route forward traffic to Docker chain" -j DOCKER
-A FORWARD -i docker0 ! -o docker0 -m comment --comment "Allow outgoing container traffic to external network" -j ACCEPT
-A FORWARD -i docker0 -o docker0 -m comment --comment "Allow inter-container communication" -j ACCEPT
-A OUTPUT -o lo -j ACCEPT
-A OUTPUT -m conntrack --ctstate ESTABLISHED -j ACCEPT
-A OUTPUT -p tcp -m tcp --sport 2221 -m conntrack --ctstate ESTABLISHED -j ACCEPT
-A OUTPUT -p tcp -m tcp --dport 2221 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
-A OUTPUT -p tcp -m tcp --dport 22 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
-A OUTPUT -p tcp -m multiport --dports 80,443 -m conntrack --ctstate ESTABLISHED -j ACCEPT
-A OUTPUT -j ACCEPT
-A DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -m comment --comment "Isolate containers from host network" -j DOCKER-ISOLATION-STAGE-2
-A DOCKER-ISOLATION-STAGE-1 -m comment --comment "Return from Docker isolation stage 1" -j RETURN
-A DOCKER-ISOLATION-STAGE-2 -o docker0 -m comment --comment "Drop packets in stage 2 isolation" -j DROP
-A DOCKER-ISOLATION-STAGE-2 -m comment --comment "Return from Docker isolation stage 2" -j RETURN
-A DOCKER-USER -m comment --comment "No custom Docker user rules" -j RETURN
COMMIT
# Completed on Mon Dec 30 09:07:57 2024
# Generated by iptables-save v1.8.10 (nf_tables) on Mon Dec 30 09:07:57 2024
*nat
:PREROUTING ACCEPT [48:7302]
:INPUT ACCEPT [1:64]
:OUTPUT ACCEPT [34:2633]
:POSTROUTING ACCEPT [34:2633]
:DOCKER - [0:0]
-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER
-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER
-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE
-A DOCKER -i docker0 -j RETURN
COMMIT
# Completed on Mon Dec 30 09:07:57 2024


